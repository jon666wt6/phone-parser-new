#!/bin/bash
set -e

echo "[ENTRYPOINT] Checking database schema for $RAILS_ENV..."

# Wait for DB (very basic wait loop)
until pg_isready -h "$DB_HOST" -p "${DB_PORT:-5432}" -U "$DB_USER"; do
  echo "Waiting for Postgres..."
  sleep 2
done

# Try to load schema.rb if tables are missing
if ! bundle exec rails runner "ActiveRecord::Base.connection.table_exists?('regions')" >/dev/null 2>&1; then
  echo "[ENTRYPOINT] Database seems empty â€” loading db/schema.rb..."
  bundle exec rails db:schema:load || true
else
  echo "[ENTRYPOINT] Database already initialized."
fi

# Continue to main process (Thruster/Rails)
exec "$@"